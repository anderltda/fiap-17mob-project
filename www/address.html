<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Anderson Nascimento">
    <title>Address</title>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-app.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-auth.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-database.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-firestore.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-storage.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-messaging.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-functions.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-waitingfor.js"></script>
    <script type="text/javascript" src="js/form-validation.js"></script>
    <script type="text/javascript" src="js/project.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/docs.min.css" rel="stylesheet">
</head>

<body>

    <header class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar">
        <a class="navbar-brand mr-0 mr-md-2" href="/" aria-label="Project">
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" class="d-block" viewBox="0 0 612 612" role="img" focusable="false">
                <title>Project</title>
                <path fill="currentColor"
                    d="M510 8a94.3 94.3 0 0 1 94 94v408a94.3 94.3 0 0 1-94 94H102a94.3 94.3 0 0 1-94-94V102a94.3 94.3 0 0 1 94-94h408m0-8H102C45.9 0 0 45.9 0 102v408c0 56.1 45.9 102 102 102h408c56.1 0 102-45.9 102-102V102C612 45.9 566.1 0 510 0z" />
                <path fill="currentColor"
                    d="M196.77 471.5V154.43h124.15c54.27 0 91 31.64 91 79.1 0 33-24.17 63.72-54.71 69.21v1.76c43.07 5.49 70.75 35.82 70.75 78 0 55.81-40 89-107.45 89zm39.55-180.4h63.28c46.8 0 72.29-18.68 72.29-53 0-31.42-21.53-48.78-60-48.78h-75.57zm78.22 145.46c47.68 0 72.73-19.34 72.73-56s-25.93-55.37-76.46-55.37h-74.49v111.4z" />
            </svg>
        </a>

        <div class="navbar-nav-scroll">
            <ul class="navbar-nav bd-navbar-nav flex-row">
                <li class="nav-item">
                    <a class="nav-link" href="home.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="profile.html">Profile</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">Address</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="contact.html" rel="noopener">Contact</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="location.html" rel="noopener">Location</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="about.html" rel="noopener">About (Sign-Out)</a>
                </li>
            </ul>
        </div>
    </header>

    <div class="container">
        <div class="row py-5">
            <div class="col-12 order-md-1">
                <h4 class="mb-3">Addres</h4>
                <div id="contents"></div>
                <form class="needs-validation" novalidate>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="cep" maxlength="8" placeholder="CEP" required>
                                <div class="input-group-append">
                                    <button id="bt_cep" class="btn btn-outline-secondary" type="button" id="button-addon2">Search</button>
                                </div>
                                <div class="invalid-feedback">
                                    É necessário informar o CEP.
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12 mb-3">
                            <input type="text" class="form-control" id="logradouro" placeholder="Logradouro" disabled>
                            <div class="invalid-feedback">
                                É necessário informar o Logradouro.
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" id="numero" placeholder="Numero" required>
                            <div class="invalid-feedback">
                                É necessário informar o Numero.
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" id="bairro" placeholder="Bairro" disabled>
                            <div class="invalid-feedback">
                                É necessário informar o Numero.
                            </div>
                        </div>

                        <div class="col-md-12 mb-3">
                            <input type="text" class="form-control" id="complemento" placeholder="Complemento">
                        </div>

                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" id="cidade" placeholder="Cidade" disabled>
                            <div class="invalid-feedback">
                                É necessário informar a Cidade.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <select class="custom-select d-block w-100" id="estado" disabled>
                                <option value="">Selecione...</option>
                                <option>AC</option>
                                <option>AL</option>
                                <option>AP</option>
                                <option>AM</option>
                                <option>BA</option>
                                <option>CE</option>
                                <option>DF</option>
                                <option>ES</option>
                                <option>GO</option>
                                <option>MA</option>
                                <option>MT</option>
                                <option>MS</option>
                                <option>MG</option>
                                <option>PA</option>
                                <option>PB</option>
                                <option>PR</option>
                                <option>PE</option>
                                <option>PI</option>
                                <option>RJ</option>
                                <option>RN</option>
                                <option>RS</option>
                                <option>RO</option>
                                <option>RR</option>
                                <option>SC</option>
                                <option>SP</option>
                                <option>SE</option>
                                <option>TO</option>
                            </select>
                            <div class="invalid-feedback">
                                Selecione um estado.
                            </div>
                        </div>
                    </div>

                    <hr class="mb-4">

                    <button id="bt_enviar" class="btn btn-primary btn-lg btn-block" type="button">Enviar</button>
                </form>
            </div>
        </div>
</body>

</html>


<script>
    var data;
    var data_user;
    $(document).ready(function() {
        waitingDialog.show('Loading...');
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                findByUser(user.uid)
                findByAddress(user.uid);
            } else {
                waitingDialog.hide();
            }
        });
    });

    function findByUser(id) {

        var docRef = db.collection("APP_USER_DEFAULT").doc(id);

        docRef.get().then(function(doc) {
            if (doc.exists) {
                data_user = doc.data();
            } else {
                console.log("No such document!");
            }
        }).catch(function(error) {
            console.log("Error getting document:", error);
        });
    }

    function findByAddress(id) {

        var docRef = db.collection("LOCATIONS").doc(id);

        docRef.get().then(function(doc) {
            if (doc.exists) {
                data = doc.data();
                $('#cep').val(data.cep);
                $('#logradouro').val(data.logradouro);
                $('#cidade').val(data.localidade);
                $('#estado').val(data.estado);
                $('#bairro').val(data.bairro);
                $('#numero').val(data.number);
                $('#complemento').val(data.complemento);
                waitingDialog.hide();
            } else {
                waitingDialog.hide();
                console.log("No such document!");
            }
        }).catch(function(error) {
            waitingDialog.hide();
            console.log("Error getting document:", error);
        });
    }

    $("#bt_cep").click(function() {

        waitingDialog.show('Loading...', {
            dialogSize: 'm',
            progressType: 'success'
        });
        setTimeout(function() {
            waitingDialog.hide();
        }, 2000);

        var cep = $('#cep').val();
        var url = "https://viacep.com.br/ws/" + cep + "/json/";
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.onload = function() {
            var address = JSON.parse(xhr.responseText);
            if (xhr.readyState == 4 && xhr.status == "200") {
                console.table(address);
                $('#logradouro').val(address.logradouro);
                $('#cidade').val(address.localidade);
                $('#estado').val(address.uf);
                $('#bairro').val(address.bairro);
                waitingDialog.hide();
            } else {
                waitingDialog.hide();
                console.error(address);
            }
        }
        xhr.send(null);
    });

    $("#bt_enviar").click(function() {

        waitingDialog.show('Salvando aguarde...', {
            dialogSize: 'm',
            progressType: 'success'
        });
        setTimeout(function() {
            waitingDialog.hide();
        }, 2000);

        saveBaseFirebase();
    });

    function saveBaseFirebase() {

        var id = data_user.id;
        var create = new Date;

        if (data && data.create) {
            create = data.create;
        }

        db.collection("LOCATIONS").doc(id).set({
                cep: $('#cep').val(),
                logradouro: $('#logradouro').val(),
                number: $('#numero').val(),
                bairro: $('#bairro').val(),
                localidade: $('#cidade').val(),
                complemento: $('#complemento').val(),
                estado: $('#estado').val(),
                id: data_user.id,
                name: data_user.name,
                lat: "-23.4834015",
                long: "-46.661051",
                gia: "",
                ibge: "",
                unidade: "",
                create: create,
                update: new Date
            })
            .then(function(docRef) {
                waitingDialog.hide();
                console.log("Document ok update");
            })
            .catch(function(error) {
                waitingDialog.hide();
                console.log("Error writing document: ", error);
            });

    }
</script>