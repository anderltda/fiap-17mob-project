<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Anderson Nascimento">
    <title>Profile</title>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-app.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-auth.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-database.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-firestore.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-storage.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-messaging.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/6.0.2/firebase-functions.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-waitingfor.js"></script>
    <script type="text/javascript" src="js/form-validation.js"></script>
    <script type="text/javascript" src="js/project.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/docs.min.css" rel="stylesheet">
</head>

<body>
    <header class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar">
        <a class="navbar-brand mr-0 mr-md-2" href="/" aria-label="Project">
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" class="d-block" viewBox="0 0 612 612" role="img" focusable="false">
                <title>Project</title>
                <path fill="currentColor"
                    d="M510 8a94.3 94.3 0 0 1 94 94v408a94.3 94.3 0 0 1-94 94H102a94.3 94.3 0 0 1-94-94V102a94.3 94.3 0 0 1 94-94h408m0-8H102C45.9 0 0 45.9 0 102v408c0 56.1 45.9 102 102 102h408c56.1 0 102-45.9 102-102V102C612 45.9 566.1 0 510 0z" />
                <path fill="currentColor"
                    d="M196.77 471.5V154.43h124.15c54.27 0 91 31.64 91 79.1 0 33-24.17 63.72-54.71 69.21v1.76c43.07 5.49 70.75 35.82 70.75 78 0 55.81-40 89-107.45 89zm39.55-180.4h63.28c46.8 0 72.29-18.68 72.29-53 0-31.42-21.53-48.78-60-48.78h-75.57zm78.22 145.46c47.68 0 72.73-19.34 72.73-56s-25.93-55.37-76.46-55.37h-74.49v111.4z" />
            </svg>
        </a>

        <div class="navbar-nav-scroll">
            <ul class="navbar-nav bd-navbar-nav flex-row">
                <li class="nav-item">
                    <a class="nav-link" href="home.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">Profile</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="address.html">Address</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="contact.html" rel="noopener">Contact</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="location.html" rel="noopener">Location</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="about.html" rel="noopener">About (Sign-Out)</a>
                </li>
            </ul>
        </div>
    </header>

    <div class="container">
        <div class="row py-5">
            <div class="col-12 order-md-1">
                <form class="needs-validation" novalidate>

                    <div class="text-center mb-4">

                        <a href="#">
                            <img id="image" class="mb-4" src="img/photo.png" style="background-color: #ddd;border-radius: 100%;height: 120px; object-fit: cover; width: 120px;" data-toggle="modal" data-target="#exampleModal">
                        </a>
                        <h1 class="h3 mb-3 font-weight-normal">Profile</h1>
                        <p>Atualize os dados abaixo</p>
                    </div>

                    <div class="row">

                        <div class="col-md-6 mb-3">
                            <input type="text" id="inputName" class="form-control" placeholder="Name" required autofocus>
                            <div class="invalid-feedback">
                                É necessário informar um nome.
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <input type="text" id="inputPhone" class="form-control" onkeypress="return event.charCode >= 48 && event.charCode <= 57" maxlength="11" placeholder="Phone xx999999999" required autofocus>
                            <div class="invalid-feedback">
                                É necessário informar um telefone celular.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">@</span>
                            </div>
                            <input type="email" class="form-control" id="inputEmail" placeholder="Email" disabled>
                            <div class="invalid-feedback" style="width: 100%;">
                                É necessário informar um email.
                            </div>
                        </div>
                    </div>

                    <!-- Modal -->
                    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">Adicionar Imagem</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary btn-block" id="camera">Camera</button>
                                    <br>
                                    <button type="button" class="btn btn-primary btn-block" id="gallery">Galeria</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="mb-4">
                    <button id="bt_enviar" class="btn btn-primary btn-lg btn-block" type="button">Enviar</button>
                </form>
            </div>
        </div>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/camera.js"></script>
</body>

</html>


<script>
    var data;
    $(document).ready(function() {
        waitingDialog.show('Loading...');
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                findByUser(user.uid);
            } else {
                waitingDialog.hide();
            }
        });
    });

    function findByUser(id) {

        var docRef = db.collection("APP_USER_DEFAULT").doc(id);

        docRef.get().then(function(doc) {
            if (doc.exists) {
                $('#inputEmail').val(doc.data().email);
                $('#inputName').val(doc.data().name);
                $('#inputPhone').val(doc.data().phone);

                if (doc.data().avatar) {
                    $('#image').attr('src', doc.data().avatar);
                }

                data = doc.data();
            } else {
                console.log("No such document!");
            }
            waitingDialog.hide();
        }).catch(function(error) {
            waitingDialog.hide();
            console.log("Error getting document:", error);
        });
    }

    $("#bt_enviar").click(function() {
        uploadFirebase();

    });

    function uploadFirebase() {

        waitingDialog.show('Salvando aguarde...', {
            dialogSize: 'm',
            progressType: 'success'
        });
        setTimeout(function() {
            waitingDialog.hide();
        }, 2000);

        var image = document.getElementById("image").src;

        if (image.indexOf('base64') !== -1) {

            var filename = data.id + "_avatar.jpg";
            var file = dataURLtoFile(image, filename);

            var metadata = {
                contentType: file.type
            };

            var uploadTask = storageRef.child('images/' + filename).put(file, metadata);

            // Listen for state changes, errors, and completion of the upload.
            uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
                function(snapshot) {
                    // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
                    var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done');
                    switch (snapshot.state) {
                        case firebase.storage.TaskState.PAUSED: // or 'paused'
                            console.log('Upload is paused');
                            break;
                        case firebase.storage.TaskState.RUNNING: // or 'running'
                            console.log('Upload is running');
                            break;
                    }
                },
                function(error) {
                    switch (error.code) {
                        case 'storage/unauthorized':
                            // User doesn't have permission to access the object
                            break;
                        case 'storage/canceled':
                            // User canceled the upload
                            break;
                        case 'storage/unknown':
                            // Unknown error occurred, inspect error.serverResponse
                            break;
                    }
                },
                function() {
                    // Upload completed successfully, now we can get the download URL
                    uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {

                        console.log('File available at', downloadURL);

                        saveBaseFirebase(downloadURL);

                    });
                });
        } else {
            saveBaseFirebase();
        }
    }

    function saveBaseFirebase(downloadURL) {

        var name = $('#inputName').val();
        var phone = $('#inputPhone').val();

        var id = data.id;
        var email = data.email;
        var create = data.create;
        var avatar = "";

        if (data && data.avatar) {
            avatar = data.avatar;
        }

        if (downloadURL) {
            avatar = downloadURL;
        }

        db.collection("APP_USER_DEFAULT").doc(id).set({
                id: id,
                name: name,
                phone: phone,
                email: email,
                avatar: avatar,
                create: create,
                update: new Date
            })
            .then(function(docRef) {
                waitingDialog.hide();
                console.log("Document ok update");
            })
            .catch(function(error) {
                waitingDialog.hide();
                console.log("Error writing document: ", error);
            });

    }

    function dataURLtoFile(dataurl, filename) {
        var arr = dataurl.split(','),
            mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]),
            n = bstr.length,
            u8arr = new Uint8Array(n);
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], filename, {
            type: mime
        });
    }
</script>